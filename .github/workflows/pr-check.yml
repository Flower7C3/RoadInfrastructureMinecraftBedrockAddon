name: Pull Request Check

on:
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Check project structure
        run: |
          echo "ğŸ” Checking project structure..."
          
          # Required files
                     required_files=(
             "config.json"
             "BP/manifest.json"
             "RP/manifest.json"
             "build.py"
           )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
          
          echo "âœ… Project structure is valid"

      - name: Verify manifests
        run: |
          echo "ğŸ“‹ Verifying manifests..."
          
          # Check BP manifest
          if python3 -c "import json; json.load(open('BP/manifest.json'))" 2>/dev/null; then
            echo "âœ… BP manifest is valid JSON"
          else
            echo "âŒ BP manifest is invalid JSON"
            exit 1
          fi
          
          # Check RP manifest
          if python3 -c "import json; json.load(open('RP/manifest.json'))" 2>/dev/null; then
            echo "âœ… RP manifest is valid JSON"
          else
            echo "âŒ RP manifest is invalid JSON"
            exit 1
          fi
          
          # Check config.json
          if python3 -c "import json; json.load(open('config.json'))" 2>/dev/null; then
            echo "âœ… config.json is valid JSON"
          else
            echo "âŒ config.json is invalid JSON"
            exit 1
          fi

      - name: Count blocks and files
        run: |
          echo "ğŸ“Š Counting project elements..."
          
          BLOCK_COUNT=$(find BP/blocks -name "*.block.json" 2>/dev/null | wc -l)
          BP_FILES=$(find BP -type f 2>/dev/null | wc -l)
          RP_FILES=$(find RP -type f 2>/dev/null | wc -l)
          
          echo "â¹ï¸ Blocks: $BLOCK_COUNT"
          echo "ğŸ“¦ BP files: $BP_FILES"
          echo "ğŸ“¦ RP files: $RP_FILES"
          
          if [ "$BLOCK_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: No blocks found"
          fi

      - name: Test build script
        run: |
          echo "ğŸ”¨ Testing build script..."
          
                     if [ -f "build.py" ]; then
             # Test if script can be imported
             python3 -c "import build" 2>/dev/null && echo "âœ… Build script is valid Python"
             
             # Test help
             python3 build.py --help > /dev/null && echo "âœ… Build script help works"
           else
             echo "âŒ build.py not found"
             exit 1
           fi

      - name: Check for texture issues
        run: |
          echo "ğŸ¨ Checking textures..."
          
          if [ -f "verify_textures.py" ]; then
            echo "Running texture verification..."
            python3 verify_textures.py || echo "âš ï¸ Texture verification found issues"
          else
            echo "âš ï¸ verify_textures.py not found, skipping texture check"
          fi

  comment:
    needs: verify
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Check Results')
            );
            
            const blockCount = ${{ steps.count.outputs.blocks || 0 }};
            const bpFiles = ${{ steps.count.outputs.bp_files || 0 }};
            const rpFiles = ${{ steps.count.outputs.rp_files || 0 }};
            
            const body = `## ğŸ” PR Check Results
            
            ### ğŸ“Š Project Statistics
            - **Blocks**: ${blockCount}
            - **BP Files**: ${bpFiles}
            - **RP Files**: ${rpFiles}
            
            ### âœ… Checks Passed
            - Project structure verification
            - Manifest validation
            - Build script testing
            
            ### ğŸš€ Ready for Review
            This PR appears to be ready for review. All basic checks have passed.
            
            ---
            *This comment was automatically generated by GitHub Actions*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } 